- name: Jumpbox server setup for multiple users
  hosts: all
  become: true
  vars_files:
    - vars.yml

  tasks:  
  - name: Install dependency packages
    apt:
      name: "{{item}}"
      state: present
      update_cache: yes
    loop:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg-agent
      - software-properties-common
      - net-tools

  - name: Add vscode GPG key
    apt_key:
      url: https://packages.microsoft.com/keys/microsoft.asc
      state: present

  - name: Add vscode repository to apt
    apt_repository:
      repo: deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main
      state: present

  - name: Install vscode
    apt:
      name: "{{item}}"
      state: latest
      update_cache: yes
    loop:
      - code

  - name: Add docker GPG key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present

  - name: Add docker repository to apt
    apt_repository:
      repo: deb https://download.docker.com/linux/ubuntu bionic stable
      state: present

  - name: Install docker
    apt:
      name: "{{item}}"
      state: latest
      update_cache: yes
    loop:
      - docker-ce
      - docker-ce-cli
      - containerd.io

  - name: Start and enable docker
    service:
      name: docker
      state: started
      enabled: yes

  - name: Install docker compose
    shell: curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose

  - name: Change docker-compose permissions
    ansible.builtin.file:
      path: /usr/local/bin/docker-compose
      mode: '0755'
  
  - name: Install ubuntu-desktop
    apt:
      name: "{{item}}"
      state: latest
      update_cache: yes
    loop:
      - ubuntu-desktop
      - tightvncserver
      - gnome-panel
      - gnome-settings-daemon
      - metacity
      - nautilus
      - gnome-terminal

  - name: Copy xstartup to /home/ubuntu/.vnc/xstartup
    copy:
      src: "xstartup"
      dest: "/home/ubuntu/.vnc/xstartup"
      owner: ubuntu
      group: ubuntu
      mode: '0755'

  - name: Copy systemd for vncserver
    copy:
      src: "{{ item }}.service"
      dest: "/usr/lib/systemd/system/{{ item }}.service"
      mode: '0644'
    loop:
      - vncserver
    notify:
      - restart_vncserver

  - name: Just force systemd to reread configs
    ansible.builtin.systemd:
      daemon_reload: yes

  handlers:
    - name: restart_vncserver
      service:
        name: vncserver
        state: restarted