name: "Copilot Setup Steps"

# Run when the setup steps change (for validation), and allow manual triggering.
# These steps execute BEFORE the Copilot agent starts and BEFORE the firewall
# is enabled, ensuring all external dependencies can be downloaded freely.
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # Job MUST be named `copilot-setup-steps` to be picked up by the Copilot agent.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Restore NuGet packages
        run: dotnet restore

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Setup Python (for pre-commit)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
