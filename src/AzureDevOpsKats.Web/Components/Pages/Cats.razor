@page "/cats"
@using AzureDevOpsKats.Web.Components.Shared
@using AzureDevOpsKats.Web.Data
@using AzureDevOpsKats.Web.Models
@using AzureDevOpsKats.Web.Services
@inject ICatService CatService
@rendermode InteractiveServer

<PageTitle>Cats - AzureDevOpsKats</PageTitle>

<h1>Cats</h1>

<div class="toolbar">
    <button class="btn" @onclick="ShowCreateForm">+ Add Cat</button>
</div>

@if (_showForm)
{
    <div class="modal-overlay" @onclick="CancelForm">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(_editingCat is null ? "Add New Cat" : "Edit Cat")</h2>
                <button type="button" class="modal-close" @onclick="CancelForm">&times;</button>
            </div>
            <EditForm Model="_formModel" OnValidSubmit="SaveCat" FormName="catForm">
                <FluentValidationValidator />
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <InputText @bind-Value="_formModel.Name" class="form-control" />
                        <ValidationMessage For="() => _formModel.Name" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <InputTextArea @bind-Value="_formModel.Description" class="form-control" />
                        <ValidationMessage For="() => _formModel.Description" />
                    </div>
                    <div class="form-group">
                        <label>Photo</label>
                        <InputFile OnChange="OnPhotoSelected" accept="image/*" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (_cats is null)
{
    <p>Loading...</p>
}
else if (_cats.Count == 0)
{
    <p>No cats yet. Add one!</p>
}
else
{
    <div class="cat-grid">
        @foreach (var cat in PagedCats)
        {
            <div class="card cat-card">
                @if (!string.IsNullOrEmpty(cat.Photo))
                {
                    <img src="uploads/@cat.Photo" alt="@cat.Name" class="cat-photo" />
                }
                else
                {
                    <div class="cat-photo placeholder">üê±</div>
                }
                <div class="cat-info">
                    <h3>@cat.Name</h3>
                    <p>@cat.Description</p>
                    <div class="cat-actions">
                        <button class="btn btn-small" @onclick="() => EditCat(cat)">Edit</button>
                        <button class="btn btn-small btn-danger" @onclick="() => DeleteCat(cat.Id)">Delete</button>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (TotalPages > 1)
    {
        <nav class="pagination">
            <button class="btn btn-small" disabled="@(_currentPage <= 1)" @onclick="PreviousPage">&laquo; Prev</button>
            @for (var i = 1; i <= TotalPages; i++)
            {
                var page = i;
                <button class="btn btn-small" disabled="@(page == _currentPage)" @onclick="() => GoToPage(page)">@(page)</button>
            }
            <button class="btn btn-small" disabled="@(_currentPage >= TotalPages)" @onclick="NextPage">Next &raquo;</button>
        </nav>
    }
}

@code {
    private const int PageSize = 9;
    private List<Cat>? _cats;
    private int _currentPage = 1;
    private bool _showForm;
    private Cat? _editingCat;
    private CatFormModel _formModel = new();
    private IBrowserFile? _selectedPhoto;

    private int TotalPages => _cats is null ? 1 : (int)Math.Ceiling(_cats.Count / (double)PageSize);
    private List<Cat> PagedCats => _cats?.Skip((_currentPage - 1) * PageSize).Take(PageSize).ToList() ?? [];

    protected override async Task OnInitializedAsync()
    {
        _cats = await CatService.GetAllAsync();
    }

    private void GoToPage(int page)
    {
        _currentPage = page;
    }

    private void PreviousPage()
    {
        if (_currentPage > 1) _currentPage--;
    }

    private void NextPage()
    {
        if (_currentPage < TotalPages) _currentPage++;
    }

    private void ShowCreateForm()
    {
        _editingCat = null;
        _formModel = new CatFormModel();
        _selectedPhoto = null;
        _showForm = true;
    }

    private void EditCat(Cat cat)
    {
        _editingCat = cat;
        _formModel = new CatFormModel { Name = cat.Name, Description = cat.Description };
        _selectedPhoto = null;
        _showForm = true;
    }

    private void CancelForm()
    {
        _showForm = false;
        _editingCat = null;
    }

    private void OnPhotoSelected(InputFileChangeEventArgs e)
    {
        _selectedPhoto = e.File;
    }

    private async Task SaveCat()
    {
        IFormFile? photo = null;
        if (_selectedPhoto is not null)
        {
            photo = new BrowserFormFile(_selectedPhoto);
        }

        if (_editingCat is not null)
        {
            await CatService.UpdateAsync(_editingCat.Id, _formModel.Name, _formModel.Description, photo);
        }
        else
        {
            await CatService.CreateAsync(_formModel.Name, _formModel.Description, photo);
        }

        _showForm = false;
        _editingCat = null;
        _cats = await CatService.GetAllAsync();
    }

    private async Task DeleteCat(long id)
    {
        await CatService.DeleteAsync(id);
        _cats = await CatService.GetAllAsync();
    }

    private sealed class BrowserFormFile(IBrowserFile file) : IFormFile
    {
        public string ContentType => file.ContentType;
        public string ContentDisposition => $"form-data; name=\"photo\"; filename=\"{file.Name}\"";
        public IHeaderDictionary Headers { get; set; } = new HeaderDictionary();
        public long Length => file.Size;
        public string Name => "photo";
        public string FileName => file.Name;

        public void CopyTo(Stream target) => CopyToAsync(target).GetAwaiter().GetResult();

        public async Task CopyToAsync(Stream target, CancellationToken cancellationToken = default)
        {
            await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            await stream.CopyToAsync(target, cancellationToken);
        }

        public Stream OpenReadStream() => file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
    }
}
